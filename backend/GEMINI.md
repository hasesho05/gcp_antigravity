# GCP認定資格プラットフォーム バックエンド開発ガイドライン (GEMINI.md)

このドキュメントは、GCP認定資格模擬試験プラットフォームのGoバックエンド開発における、アーキテクチャの原則、コーディング規則、および標準的な開発プラクティスを定義するものです。開発エージェント(Gemini)および人間の開発者は、コードベースの一貫性を保つため、このガイドラインに従う必要があります。

## 1. アーキテクチャ原則

当プロジェクトでは、**Clean Architecture + Domain Driven Design (Lightweight)** を採用します。これにより、関心事の分離を徹底し、テスト可能で保守性の高いコードベースを目指します。

### 1.1. 依存関係のルール

依存関係は、常に外側（`infra`, `handler`）から内側（`domain`）への一方向でなければなりません。内側のレイヤーは、外側のレイヤーについて一切関知しません。

- **`domain`**: アプリケーションの最も中心的なビジネスロジックとデータ構造（エンティティ）を定義します。他のどのレイヤーにも依存しません。
- **`usecase`**: アプリケーション固有のユースケースを実装します。`domain`と`repository`インターフェースに依存します。
- **`repository`**: データ永続化のためのインターフェース（抽象）を定義します。
- **`handler`**: HTTPリクエストを解釈し、`usecase`を呼び出してレスポンスを返します。
- **`repository_impl`**: `repository`インターフェースの具象実装です。`domain`エンティティとDBモデルの変換を担当し、`infra`に依存します。
- **`infra`**: データベース（Firestore）や外部APIクライアントなど、低レイヤーの実装を担当します。

### 1.2. ディレクトリ構造

```
.
├── Makefile
├── cmd/api/main.go      # エントリーポイント
├── internal
│   ├── domain           # ドメイン層 (エンティティ)
│   ├── usecase          # ユースケース層 (Input/Output DTO含む)
│   ├── repository       # リポジトリインターフェース (各エンティティごとにファイルを分割)
│   ├── repository_impl  # リポジトリ実装
│   ├── handler          # プレゼンテーション層
│   └── infra            # インフラ層 (DBクライアント等)
└── go.mod
```

## 2. コーディング規則

### 2.1. エラーハンドリング

- **標準ライブラリ**: `github.com/cockroachdb/errors` を一貫して使用します。
- **コンテキストの付与**: `repository`や`infra`層からエラーを返す際は、必ず `errors.Wrap(err, "コンテキストを示すメッセージ")` を使用し、エラーの発生源を明確にします。
- **スタックトレース**: `handler`層でエラーを受け取った際は、`fmt.Printf("%+v\n", err)` を用いて完全なスタックトレースをログに出力し、デバッグを容易にします。

### 2.2. UsecaseとDTO (Data Transfer Object)

- **Input/Output DTO**: `usecase`のメソッドは、ドメインエンティティを直接引数に取ったり、返り値にしたりしてはいけません。必ず `usecase/input` と `usecase/output` パッケージに定義されたDTOを使用します。
- **責務の分離**: このプラクティスにより、コアなビジネスロジック(`domain`)と、そのオーケストレーション層(`usecase`)が明確に分離されます。
- **バリデーション**: `input` DTOのコンストラクタ（例: `input.NewCreateAttempt()`) 内でパラメータのバリデーションを行い、`usecase`が常に有効なデータを受け取ることを保証します。

### 2.3. ドメインオブジェクトの生成

- **コンストラクタの使用**: ドメインオブジェクトは、必ずドメイン層で定義されたコンストラクタ（例: `domain.NewQuestion()`）を用いて生成します。構造体の直接初期化 (`&domain.Question{...}`) は禁止です。
- **不変性の保証**: コンストラクタ内でバリデーションを行うことで、不正な状態のドメインオブジェクトが生成されることを防ぎます。

### 2.4. APIレスポンス

- **`GET`リクエスト**: 要求されたリソースが存在しない場合、`404 Not Found`ではなく、`200 OK`と共にデフォルトの空オブジェクト（例: `output.UserExamStats{}`）を返却します。これによりフロントエンドの実装が簡素化されます。

## 3. 共通パッケージとライブラリ

プロジェクト全体で使用が推奨される共通パッケージです。

- **`github.com/cockroachdb/errors`**:
  - **目的**: スタックトレース付きのエラーハンドリング。
  - **使用法**: `errors.Wrap()` でコンテキストを追加し、`errors.Is()` / `errors.As()` でエラーの種類を判別します。

- **`github.com/google/uuid`**:
  - **目的**: エンティティID（例: `AttemptID`）など、一意なIDの生成。
  - **使用法**: `uuid.NewString()` で新しいIDを生成します。

- **`github.com/samber/lo`**:
  - **目的**: Goのスライスやマップ操作を簡潔にするためのユーティリティ。
  - **注意**: `lo.Map` など、インデックスが不要な場合は `internal/util/mapper.go` に定義されたカスタムラッパー `util.Map` の使用を優先します。

- **`github.com/h-nosaka/tygo`**:
  - **目的**: Goの構造体からTypeScriptの型定義を自動生成します。フロントエンドとの型安全性を保証します。
  - **使用法**: `make generate-types` コマンド経由で実行します。

```